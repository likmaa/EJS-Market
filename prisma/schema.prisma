// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  MANAGER
  CUSTOMER
  B2B_CUSTOMER
}

enum OrderStatus {
  PENDING
  PAID
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
  REFUNDED
}

model User {
  id            String    @id @default(uuid())
  email         String    @unique
  passwordHash  String
  name          String?
  role          UserRole  @default(CUSTOMER)
  isEmailVerified Boolean @default(false)
  vatNumber     String?   // Pour B2B (ex: FR12345678901)
  addresses     Address[]
  orders        Order[]
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([email])
  @@map("users")
}

model Address {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  type        String   // "billing" ou "shipping"
  firstName   String
  lastName    String
  company     String?
  addressLine1 String
  addressLine2 String?
  city        String
  postalCode  String
  country     String   // Code ISO (FR, ES, DE, etc.)
  phone       String?
  isDefault   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId])
  @@map("addresses")
}

model Product {
  id            String      @id @default(uuid())
  sku           String      @unique
  name          Json        // { fr: "iPhone 15", en: "iPhone 15", es: "..." }
  description   Json?       // { fr: "...", en: "..." }
  priceHT       Int         // En centimes (ex: 99900 = 999.00€)
  defaultVATRate Float      // 0.20 pour 20%
  weight        Float       // kg
  dimensions    Json        // { length: 100, width: 50, height: 20 } en cm
  stock         Int         @default(0)
  brand         String
  category      String      // "electronics", "garden", "photo", "mobility", "tools"
  images        String[]    // URLs des images (CDN)
  attributes    Json?       // Attributs spécifiques (JSONB)
  isActive      Boolean     @default(true)
  orderItems    OrderItem[]
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  @@index([sku])
  @@index([brand])
  @@index([category])
  @@index([isActive])
  @@map("products")
}

model TaxRate {
  id          String  @id @default(uuid())
  countryCode String  @unique // "FR", "ES", "DE", "IT", "BE", etc.
  rate        Float   // 0.20 pour 20%
  reducedRate Float?  // 0.055 pour 5.5% (optionnel)
  isActive    Boolean @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("tax_rates")
}

model Order {
  id              String      @id @default(uuid())
  userId          String
  user            User        @relation(fields: [userId], references: [id])
  status          OrderStatus @default(PENDING)
  totalHT         Int         // En centimes
  totalTTC        Int         // En centimes
  vatAmount       Int         // En centimes
  shippingCost    Int         // En centimes
  shippingAddress Json        // Adresse complète au moment de la commande
  billingAddress  Json?       // Adresse de facturation
  paymentIntentId String?     // Stripe PaymentIntent ID
  paymentMethod   String?     // "card", "paypal", etc.
  trackingNumber  String?
  items           OrderItem[]
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  @@index([userId])
  @@index([status])
  @@index([paymentIntentId])
  @@map("orders")
}

model OrderItem {
  id        String   @id @default(uuid())
  orderId   String
  order     Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  productId String
  product   Product  @relation(fields: [productId], references: [id])
  quantity  Int
  priceHT   Int      // Prix au moment de la commande (en centimes)
  vatRate   Float    // Taux TVA appliqué
  createdAt DateTime @default(now())

  @@index([orderId])
  @@index([productId])
  @@map("order_items")
}

model ShippingZone {
  id          String   @id @default(uuid())
  name        String   // "Zone 1 - Europe de l'Ouest"
  countries   String[] // ["FR", "BE", "NL", "DE"]
  basePrice   Int      // Prix de base en centimes
  pricePerKg  Int?     // Prix par kg supplémentaire (optionnel)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("shipping_zones")
}

model ShippingMethod {
  id            String   @id @default(uuid())
  name          String   // "Standard", "Express", "Spécial"
  carrier       String?  // "DHL", "UPS", "DPD", etc.
  maxWeight     Float?   // kg (null = pas de limite)
  maxDimension  Float?   // cm (null = pas de limite)
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("shipping_methods")
}

// Contenu dynamique du site
model Partner {
  id          String   @id @default(uuid())
  name        String   // Nom de la marque
  logoPath    String   // Chemin vers le logo local
  cdnUrl      String?  // URL CDN de fallback
  width       Int?     // Largeur du logo
  height      Int?     // Hauteur du logo
  alt         String   // Texte alternatif
  order       Int      @default(0) // Ordre d'affichage
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([isActive])
  @@index([order])
  @@map("partners")
}

model Testimonial {
  id          String   @id @default(uuid())
  name        String   // Nom du client
  initial     String   // Initiales pour l'avatar
  rating      Int      // Note de 1 à 5
  text        Json     // { fr: "...", en: "..." }
  product     String   // Nom du produit concerné
  date        String   // "Il y a 2 semaines"
  order       Int      @default(0) // Ordre d'affichage
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([isActive])
  @@index([order])
  @@map("testimonials")
}

model HeroImage {
  id          String   @id @default(uuid())
  type        String   // "tech" ou "garden"
  name        String   // Nom du produit
  mediaType   String   @default("image") // "image" ou "video"
  imageUrl    String?  // URL de l'image (optionnel si vidéo)
  videoUrl    String?  // URL de la vidéo (optionnel si image)
  thumbnailUrl String? // URL de la miniature pour la vidéo
  price       Int?     // Prix en centimes (optionnel)
  productId   String?  // ID du produit associé (optionnel)
  available   Boolean  @default(true)
  order       Int      @default(0) // Ordre d'affichage
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([type])
  @@index([isActive])
  @@index([order])
  @@map("hero_images")
}

model ImmersiveImage {
  id          String   @id @default(uuid())
  name        String   // Nom du produit
  mediaType   String   @default("image") // "image" ou "video"
  imageUrl    String?  // URL de l'image (optionnel si vidéo)
  videoUrl    String?  // URL de la vidéo (optionnel si image)
  thumbnailUrl String? // URL de la miniature pour la vidéo
  productId   String?  // ID du produit associé (optionnel)
  order       Int      @default(0) // Ordre d'affichage
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([isActive])
  @@index([order])
  @@map("immersive_images")
}

model ContentHistory {
  id          String   @id @default(uuid())
  contentType String   // "partner", "testimonial", "heroImage", "immersiveImage"
  contentId   String   // ID du contenu modifié
  action      String   // "create", "update", "delete", "toggle_active"
  changes     Json?    // Objet JSON avec les changements (avant/après)
  userId      String?  // ID de l'utilisateur qui a fait la modification
  userName    String?  // Nom de l'utilisateur (pour éviter les jointures)
  createdAt   DateTime @default(now())

  @@index([contentType, contentId])
  @@index([createdAt])
  @@map("content_history")
}

// Paramètres globaux du site (barre d'actualités, etc.)
model SiteSettings {
  id           String   @id @default("global")
  newsBarText  String   // Texte de la barre d'actualités en haut du site
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@map("site_settings")
}


